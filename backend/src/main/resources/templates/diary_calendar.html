<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ìƒ, ì“°ë‹¤ - ì¼ê¸° ê¸°ë¡ ë° ë‹¬ë ¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #F4DDB8; /* WHEAT */
            color: #495235; /* DARK FERN */
        }
        .container-card {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #B87B5C; /* BROWN SUGAR */
        }
        .section-title {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 600; /* font-semibold */
            color: #90533B; /* CHESTNUT */
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #B87B5C; /* BROWN SUGAR */
            padding-bottom: 0.5rem;
        }
        .info-item { /* ê¸°ì¡´ CSSì—ì„œ ì‚¬ìš©ëœ info-item ìŠ¤íƒ€ì¼ ìœ ì§€ */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #E0E0E0;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 500;
            color: #495235;
        }
        .info-value {
            color: #8F9562;
            font-weight: 400;
        }
        /* Common button styles */
        .btn-main {
            background-color: #DA983C; /* HARVEST GOLD */
            color: white;
            padding: 1rem 2.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.25rem;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-main:hover {
            background-color: #90533B; /* CHESTNUT */
            transform: translateY(-2px);
        }
        .btn-nav { /* for calendar nav */
            background-color: #B87B5C;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-nav:hover {
            background-color: #90533B;
        }
        /* New toggle button style */
        .btn-toggle {
            background-color: #8F9562; /* MOSS GREEN */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        .btn-toggle:hover {
            background-color: #495235; /* DARK FERN */
        }
        /* AI Chat button moved to action area */
        .btn-ai-chat-action {
            background-color: #8F9562; /* MOSS GREEN */
            color: white;
            padding: 1rem 2.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.25rem;
            transition: background-color 0.2s ease-in-out;
            width: 100%; /* ë„ˆë¹„ë¥¼ ê½‰ ì±„ìš°ë„ë¡ */
        }
        .btn-ai-chat-action:hover {
            background-color: #495235; /* DARK FERN */
        }

        /* Input field style */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #B87B5C;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #495235;
            background-color: white;
        }
        .input-field:focus {
            outline: none;
            border-color: #DA983C;
            box-shadow: 0 0 0 2px rgba(218, 152, 60, 0.2);
        }

        /* AI Comment Box */
        .ai-comment-box {
            background-color: #F4DDB8;
            border: 1px solid #8F9562;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: visible;
            display: flex; /* ë‚´ë¶€ ìš”ì†Œë“¤ì„ flexë¡œ ì •ë ¬ */
            flex-direction: column; /* ì„¸ë¡œë¡œ ì •ë ¬ */
            flex-shrink: 0; /* ì´ ìš”ì†ŒëŠ” ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
        }
        .stamp-image-comment {
            position: absolute;
            top: -30px;
            right: -30px;
            width: 120px;
            height: 120px;
            transform: rotate(10deg);
            opacity: 0.85;
            z-index: 10;
        }
        .record-item {
            background-color: white;
            border: 1px solid #B87B5C;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            color: #495235;
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            height: 320px; /* ë‹¬ë ¥ ë†’ì´ë¥¼ ì¤„ì—¬ì„œ ì£¼ì°¨ë³„ ë¦¬í¬íŠ¸ ê³µê°„ í™•ë³´ */
            flex-shrink: 0; /* ë¶€ëª¨ flex ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ í•¨ */
        }
        .date-cell {
            background-color: white;
            border: 1px solid #B87B5C;
            border-radius: 0.75rem;
            padding: 0.75rem;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            position: relative;
            overflow: hidden;
            color: #495235;
        }
        .date-cell:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .date-cell.has-diary {
            background-color: #F4DDB8;
            border-color: #8F9562;
        }
        .date-cell.today {
            border: 2px solid #DA983C;
            font-weight: bold;
        }
        .stamp-image-calendar {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            transform: translate(-50%, -50%) rotate(10deg);
            opacity: 1;
            filter: drop-shadow(0 2px 6px rgba(60,40,120,0.18)) contrast(1.15) brightness(1.1);
            pointer-events: none;
            z-index: 2;
            transition: opacity 0.3s ease-in-out;
        }
        
        .stamp-image-calendar.loading {
            opacity: 0;
        }
        .date-cell .date-number {
            position: relative;
            z-index: 3;
            font-weight: bold;
            font-size: 1.1em;
        }
        .emotion-icon {
            font-size: 1.3rem;
            margin-top: 0.3rem;
            color: #90533B;
        }
        /* Left Section: Calendar container */
        .left-section-container {
            flex-grow: 1; 
            min-height: 550px; 
            height: 800px; /* ê³ ì • ë†’ì´ ì„¤ì • (ìŠ¤í¬ë¦°ìƒ· ë¹„ìœ¨ì— ë§ì¶° ì¡°ì •) */
            overflow-y: auto; /* ë¦¬í¬íŠ¸ ëª©ë¡ì´ ë§ì•„ì§€ë©´ ìŠ¤í¬ë¡¤ë˜ë„ë¡ */
        }

        /* Right Section container */
        .right-section-container {
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ì±„ìš°ë„ë¡ ì„±ì¥ */
            min-height: 550px; /* ì™¼ìª½ê³¼ ë¹„ìŠ·í•œ ìµœì†Œ ë†’ì´ ë³´ì¥ */
            height: 800px; /* ì™¼ìª½ê³¼ ë™ì¼í•˜ê²Œ ê³ ì • ë†’ì´ ì„¤ì • */
            display: flex;
            flex-direction: column;
        }
        /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ê¸°ë¡ ëª©ë¡ì˜ ì§ì ‘ì ì¸ ë¶€ëª¨ë¥¼ ì§€ì • */
        .records-list-wrapper {
            min-height: 200px; /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
            max-height: 350px; /* ìµœëŒ€ ë†’ì´ ì œí•œ - ìŠ¤í¬ë¡¤ ìƒê¸°ë„ë¡ */
            overflow-y: auto; /* ë‚´ë¶€ì˜ ê¸°ë¡ë“¤ë§Œ ìŠ¤í¬ë¡¤ë˜ë„ë¡ */
            padding: 1rem; /* ìƒìì²˜ëŸ¼ íŒ¨ë”© ì¶”ê°€ */
            padding-bottom: 1.5rem; /* í•˜ë‹¨ íŒ¨ë”©ì„ ë” ëŠ˜ë¦¼ */
            border: 1px solid #B87B5C; /* ì–‡ì€ í…Œë‘ë¦¬ ì¶”ê°€ */
            border-radius: 0.5rem; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            margin-bottom: 1rem; /* í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
            background-color: white; /* ë°°ê²½ìƒ‰ë„ í•˜ì–€ìƒ‰ìœ¼ë¡œ í†µì¼ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* ì€ì€í•œ ê·¸ë¦¼ì */
        }
        /* ì˜¤ëŠ˜ì˜ ëª…ì–¸ ë¸”ë¡ ìŠ¤íƒ€ì¼ */
        .daily-quote-box {
            background-color: #F4DDB8; /* WHEAT */
            border: 1px dashed #DA983C; /* HARVEST GOLD */
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem; /* ìƒˆë¡œìš´ ê¸°ë¡ ë‚¨ê¸°ê¸° ì„¹ì…˜ê³¼ì˜ ê°„ê²© */
            text-align: center;
            font-style: italic;
            color: #90533B; /* CHESTNUT */
            line-height: 1.5;
            font-size: 1.1rem;
        }
        .modal-bg {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.3); z-index: 50; display: flex; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; border-radius: 1rem; padding: 2rem; min-width: 350px; max-width: 90vw;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; color: #B87B5C; cursor: pointer;
        }
        .emotion-icon-modal { font-size: 2rem; margin-right: 0.5rem; }
        .stamp-image-modal { width: 60px; height: 60px; margin-left: 1rem; }
        
        /* Skeleton Loading Styles */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.5rem;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-calendar {
            height: 380px;
            width: 100%;
        }
        
        .skeleton-record {
            height: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .skeleton-text:last-child {
            width: 60%;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 1rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #DA983C;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Animation for record items */
        .record-item {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .record-item.fade-out {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
        
        /* Enhanced hover effects for calendar */
        .date-cell {
            transition: all 0.2s ease-in-out;
        }
        
        .date-cell:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .date-cell.selected {
            border: 3px solid #DA983C;
            background-color: #F4DDB8;
            transform: scale(1.1);
            z-index: 5;
        }
        
        /* Emotion button styles */
        .emotion-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #B87B5C;
            border-radius: 50%;
            background: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emotion-btn:hover {
            transform: scale(1.1);
            border-color: #DA983C;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .emotion-btn.selected {
            background-color: #F4DDB8;
            border-color: #DA983C;
            transform: scale(1.1);
        }
        
        /* ===================== NEW EMOTION STATS STYLES ===================== */
        /* 2025-01-XX: ì£¼ìš” ê°ì • í‘œì‹œ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .emotion-stats {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .emotion-stat-item {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background-color: #F4DDB8;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: #90533B;
            border: 1px solid #B87B5C;
            margin: 0 0.25rem;
        }
        
        .emotion-stat-count {
            font-size: 0.8rem;
            color: #8F9562;
            font-weight: 500;
        }
        
        /* ë‹¬ë ¥ í•˜ë‹¨ ì •ë³´ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .calendar-info-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .calendar-info-section p {
            margin: 0;
            white-space: nowrap;
        }
        
        /* ì£¼ì°¨ë³„ ë¦¬í¬íŠ¸ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .weekly-reports-section {
            min-height: 150px;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .weekly-reports-section::-webkit-scrollbar {
            width: 6px;
        }
        
        .weekly-reports-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .weekly-reports-section::-webkit-scrollbar-thumb {
            background: #B87B5C;
            border-radius: 3px;
        }
        
        .weekly-reports-section::-webkit-scrollbar-thumb:hover {
            background: #90533B;
        }
        
        /* ì™¼ìª½ ì„¹ì…˜ ìŠ¤í¬ë¡¤ ì œê±° */
        .left-section-container {
            overflow: hidden;
            position: relative;
        }
        
        /* ì˜¤ë¥¸ìª½ ì„¹ì…˜ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ (ë¸Œë¼ìš´ ê³„ì—´ ìœ ì§€) */
        .records-list-wrapper::-webkit-scrollbar {
            width: 6px;
        }
        
        .records-list-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .records-list-wrapper::-webkit-scrollbar-thumb {
            background: #B87B5C;
            border-radius: 3px;
        }
        
        .records-list-wrapper::-webkit-scrollbar-thumb:hover {
            background: #90533B;
        }
        /* ===================== END NEW EMOTION STATS STYLES ===================== */
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4 sm:px-6 lg:px-8">
    <header class="w-full max-w-4xl text-center mb-10">
        <h1 class="text-5xl font-bold text-[#90533B] mb-2">ì¸ìƒ, ì“°ë‹¤</h1>
        <p class="text-2xl text-[#495235]">ì¼ê¸° ê¸°ë¡ ë° ë‹¬ë ¥</p>
        <!-- ìœ ì € ë‹‰ë„¤ì„ í‘œì‹œ (í…ŒìŠ¤íŠ¸ìš©: ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ ì‹œ) -->
        <div th:if="${user != null}" class="mt-2 text-lg text-[#8F9562] font-semibold">
            í™˜ì˜í•©ë‹ˆë‹¤, <span th:text="${user.userNickname}"></span>ë‹˜!
        </div>
    </header>

    <section id="diary-calendar-page-section" class="w-full max-w-5xl flex flex-col lg:flex-row gap-8 py-10">
        <div class="lg:w-1/2 container-card left-section-container">
            <div class="flex justify-between items-center mb-6">
                <button id="prev-month-btn" class="btn-nav">&lt; ì´ì „ ë‹¬</button>
                <h2 id="calendar-title" class="text-3xl font-semibold text-[#90533B]">2025ë…„ 7ì›”</h2>
                <button id="next-month-btn" class="btn-nav">ë‹¤ìŒ ë‹¬ &gt;</button>
            </div>
            <div id="calendar-grid" class="calendar-grid mb-4"></div>
            <div class="text-center text-base text-[#8F9562] mt-4">
                <div class="calendar-info-section">
                    <p id="calendar-summary">ì´ë²ˆ ë‹¬ ì¼ê¸°: 0ì¼ ì‘ì„± | ì—°ì† ê¸°ë¡: 0ì¼</p>
                    <p id="calendar-emotions">ì£¼ìš” ê°ì •: -</p>
                </div>
            </div>
            <div class="mt-8 weekly-reports-section">
                <h3 class="text-xl font-semibold text-[#90533B] mb-4">ì£¼ì°¨ë³„ ê°ì • ë¦¬í¬íŠ¸</h3>
                <div id="weekly-reports-list" class="space-y-3"></div>
            </div>
        </div>

        <div class="lg:w-1/2 container-card flex flex-col right-section-container"> 
            <!-- ê¸°ë¡ ëª©ë¡ ì„¹ì…˜ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
            <div class="flex-shrink-0 mb-4"> 
                <div class="flex justify-between items-center mb-3">
                    <h2 class="block text-xl font-semibold text-[#90533B]">ì˜¤ëŠ˜ì˜ ì§§ì€ ê¸°ë¡ë“¤</h2>
                    <button id="search-toggle-btn" class="text-[#8F9562] hover:text-[#495235] transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Search Bar -->
                <div id="search-bar" class="mb-3 hidden">
                    <input type="text" id="search-input" class="w-full input-field" placeholder="ê¸°ë¡ ë‚´ìš©ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”...">
                </div>
            </div>
            
            <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ê¸°ë¡ ëª©ë¡ -->
            <div class="records-list-wrapper flex-1"> 
                <div id="today-records-list-scrollable" class="space-y-2"> 
                    <div class="record-item">
                        <span class="text-[#8F9562] text-sm mr-2">[10:30]</span>
                        ì˜¤ëŠ˜ ì•„ì¹¨ í–‡ì‚´ì´ ë„ˆë¬´ ì¢‹ì•„ì„œ ê¸°ë¶„ ì¢‹ê²Œ ì¼ì–´ë‚¬ì–´ìš”.
                    </div>
                    <div class="record-item">
                        <span class="text-[#8F9562] text-sm mr-2">[14:15]</span>
                        ì ì‹¬ìœ¼ë¡œ ë§›ìˆëŠ” íŒŒìŠ¤íƒ€ë¥¼ ë¨¹ì—ˆëŠ”ë°, ì •ë§ í–‰ë³µí–ˆì–´ìš”!
                    </div>
                    <div class="record-item">
                        <span class="text-[#8F9562] text-sm mr-2">[16:00]</span>
                        ì˜¤í›„ì—ëŠ” ì¹œêµ¬ì™€ ì¹´í˜ì—ì„œ ìˆ˜ë‹¤ë¥¼ ë–¨ì—ˆëŠ”ë°, ì¦ê±°ì› ì–´ìš”!
                    </div>
                    <div class="record-item">
                        <span class="text-[#8F9562] text-sm mr-2">[18:30]</span>
                        ì €ë…ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ìƒëŸ¬ë“œë¥¼ ë¨¹ì—ˆì–´ìš”. ê±´ê°•í•œ ëŠë‚Œ!
                    </div>
                    <div class="record-item">
                        <span class="text-[#8F9562] text-sm mr-2">[20:00]</span>
                        ì¢‹ì•„í•˜ëŠ” ë“œë¼ë§ˆë¥¼ ë³´ë©´ì„œ í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤.
                    </div>
                    <div class="record-item">
                        <span class="text-[#8F9562] text-sm mr-2">[21:00]</span>
                        ìƒˆë¡œìš´ ì±…ì„ ì½ê¸° ì‹œì‘í–ˆëŠ”ë°, ë‚´ìš©ì´ ì •ë§ í¥ë¯¸ë¡œì›Œìš”!
                    </div>
                    <div class="record-item">
                        <span class="text-[#8F9562] text-sm mr-2">[22:30]</span>
                        ë‚´ì¼ ì¼ì •ì„ ì •ë¦¬í•˜ë©° ì ìë¦¬ì— ë“¤ ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.
                    </div>
                    <div id="no-records-placeholder" class="text-center py-8 hidden">
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto text-[#8F9562] opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-[#495235] mb-2">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”</h3>
                        <p class="text-[#8F9562] mb-4">ì˜¤ëŠ˜ì˜ ì²« ë²ˆì§¸ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
                        <div class="text-sm text-[#B87B5C]">
                            <p>âœ¨ ì‘ì€ ìˆœê°„ë„ ì†Œì¤‘í•œ ê¸°ë¡ì´ ë©ë‹ˆë‹¤</p>
                            <p>ğŸ“ ì§€ê¸ˆ ë‹¹ì‹ ì˜ ìƒê°ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="daily-quote-box mb-4 flex-shrink-0">
                <p id="daily-quote-text">"ë‹¹ì‹ ì˜ ì‘ì€ ë…¸ë ¥ì´ ëª¨ì—¬ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤."</p>
                <p class="text-sm mt-2">- ì•Œ ìˆ˜ ì—†ëŠ” ì‘ê°€ -</p>
            </div>

            <div id="ai-comment-section" class="ai-comment-box mb-4 flex-shrink-0 hidden">
                <img src="/images/ì°¸ì˜í–ˆì–´ìš”.png" alt="ì°¸ì˜í–ˆì–´ìš” ìŠ¤íƒ¬í”„" class="stamp-image-comment">
                <h3 class="text-2xl font-semibold text-[#90533B] mb-4">ì„ ìƒë‹˜ì˜ ë”°ëœ»í•œ ì½”ë©˜íŠ¸</h3>
                <p id="ai-comment-text" class="text-[#495235] leading-relaxed text-lg">
                    ì‚¬ë‘í•˜ëŠ” ì œìë‹˜, ì˜¤ëŠ˜ ë‚¨ê²¨ì£¼ì‹  ì†Œì¤‘í•œ ê¸°ë¡ë“¤ì„ ì½ì—ˆì–´ìš”.
                    ì‘ì€ ìˆœê°„ë“¤ì´ ëª¨ì—¬ ì œìë‹˜ì˜ í•˜ë£¨ë¥¼ ì•„ë¦„ë‹µê²Œ ì±„ìš°ê³  ìˆë„¤ìš”.
                    ì˜¤ëŠ˜ì˜ ê¸°ë¡ì„ í†µí•´ [ê°ì • í‚¤ì›Œë“œ ì˜ˆì‹œ: ê¸°ì¨, í‰ì˜¨]ì´ ëŠê»´ì§‘ë‹ˆë‹¤.
                    ê¾¸ì¤€íˆ ìì‹ ì„ ëŒì•„ë³´ëŠ” ëª¨ìŠµì´ ì°¸ ëŒ€ê²¬í•´ìš”.
                </p>
            </div>

            <div id="new-record-section" class="flex-shrink-0 mt-auto"> 
                <label for="diary-content" class="block text-xl font-semibold text-[#90533B] mb-3">ìƒˆë¡œìš´ ê¸°ë¡ ë‚¨ê¸°ê¸°</label>
                
                <!-- Emotion Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-[#495235] mb-2">ì˜¤ëŠ˜ì˜ ê°ì •</label>
                    <div class="flex flex-wrap gap-2">
                        <button class="emotion-btn" data-emotion="ğŸ˜Š" title="í–‰ë³µ">ğŸ˜Š</button>
                        <button class="emotion-btn" data-emotion="ğŸ˜¢" title="ìŠ¬í””">ğŸ˜¢</button>
                        <button class="emotion-btn" data-emotion="ğŸ˜¡" title="í™”ë‚¨">ğŸ˜¡</button>
                        <button class="emotion-btn" data-emotion="ğŸ˜Œ" title="í‰ì˜¨">ğŸ˜Œ</button>
                        <button class="emotion-btn" data-emotion="ğŸ¤”" title="ê³ ë¯¼">ğŸ¤”</button>
                        <button class="emotion-btn" data-emotion="ğŸ˜´" title="í”¼ê³¤">ğŸ˜´</button>
                        <button class="emotion-btn" data-emotion="ğŸ˜" title="ì‚¬ë‘">ğŸ˜</button>
                        <button class="emotion-btn" data-emotion="ğŸ˜¤" title="ìŠ¤íŠ¸ë ˆìŠ¤">ğŸ˜¤</button>
                    </div>
                </div>
                
                <textarea id="diary-content" rows="3" class="w-full input-field resize-y" placeholder="ì§€ê¸ˆ ë‹¹ì‹ ì˜ ìƒê°ì´ë‚˜ ê°ì •ì„ í•œë‘ ì¤„ë¡œ ììœ ë¡­ê²Œ ê¸°ë¡í•´ì£¼ì„¸ìš”."></textarea>
            </div>
            
            <div class="flex flex-col gap-4 mt-4 flex-shrink-0"> 
                <button id="ai-chat-button" class="btn-ai-chat-action hidden"> AIì™€ ì±„íŒ…í•˜ê¸°
                </button>
                <div class="flex justify-center items-center gap-4"> 
                    <button id="save-diary-btn" class="btn-main flex-grow"> ìƒê° ê¸°ë¡í•˜ê¸°
                    </button>
                    <button id="toggle-comment-record-btn" class="btn-toggle">
                        ì½”ë©˜íŠ¸ ë³´ê¸° (í…ŒìŠ¤íŠ¸ìš©)
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- ì¼ê¸° ìƒì„¸/ì‘ì„± ëª¨ë‹¬ -->
    <div id="diary-modal" class="modal-bg" style="display:none;">
        <div class="modal-box relative">
            <span class="modal-close" onclick="closeDiaryModal()">&times;</span>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        // --- Combined Diary/Calendar Page Scripts ---
        
        // Loading state management
        let isLoading = false;
        
        // Skeleton UI functions
        function showCalendarSkeleton() {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = `
                <div class="skeleton skeleton-calendar"></div>
            `;
        }
        
        function showRecordsSkeleton() {
            const recordsList = document.getElementById('today-records-list-scrollable');
            recordsList.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const skeletonItem = document.createElement('div');
                skeletonItem.className = 'skeleton skeleton-record';
                recordsList.appendChild(skeletonItem);
            }
        }
        
        function showWeeklyReportsSkeleton() {
            const reportsList = document.getElementById('weekly-reports-list');
            reportsList.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const skeletonItem = document.createElement('div');
                skeletonItem.className = 'skeleton skeleton-record';
                reportsList.appendChild(skeletonItem);
            }
        }
        
        function hideSkeletons() {
            // Skeletons will be replaced by actual content
        }
        
        // Lazy loading for images
        function lazyLoadImage(img) {
            if (img.dataset.src) {
                img.classList.add('loading');
                img.src = img.dataset.src;
                img.onload = function() {
                    img.classList.remove('loading');
                    img.removeAttribute('data-src');
                };
                img.onerror = function() {
                    img.classList.remove('loading');
                    img.style.display = 'none';
                };
            }
        }
        
        // Intersection Observer for lazy loading
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    lazyLoadImage(img);
                    observer.unobserve(img);
                }
            });
        });
        
        // Error handling
        function showErrorMessage(message) {
            // Create error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // Success message handling
        function showSuccessMessage(message) {
            // Create success notification
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm';
            successDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 3000);
        }
        
        const aiCommentSection = document.getElementById('ai-comment-section');
        const newRecordSection = document.getElementById('new-record-section');
        const toggleCommentRecordBtn = document.getElementById('toggle-comment-record-btn');
        // ì½”ë©˜íŠ¸ë³´ê¸° ë²„íŠ¼ì€ ì£¼ì„ì²˜ë¦¬/ìˆ¨ê¹€ ì²˜ë¦¬
        if (toggleCommentRecordBtn) toggleCommentRecordBtn.style.display = 'none';
        const recordsListScrollable = document.getElementById('today-records-list-scrollable');
        const noRecordsPlaceholder = document.getElementById('no-records-placeholder');
        const saveDiaryBtn = document.getElementById('save-diary-btn');
        const diaryContent = document.getElementById('diary-content');
        const aiChatButton = document.getElementById('ai-chat-button'); // AI ì±„íŒ… ë²„íŠ¼
        const dailyQuoteBox = document.querySelector('.daily-quote-box'); // ì˜¤ëŠ˜ì˜ ëª…ì–¸ ë¸”ë¡
        
        // Emotion selection
        let selectedEmotion = null;
        const emotionButtons = document.querySelectorAll('.emotion-btn');
        
        emotionButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove previous selection
                emotionButtons.forEach(b => b.classList.remove('selected'));
                // Add selection to current button
                this.classList.add('selected');
                selectedEmotion = this.dataset.emotion;
            });
        });
        
        // Search functionality
        const searchToggleBtn = document.getElementById('search-toggle-btn');
        const searchBar = document.getElementById('search-bar');
        const searchInput = document.getElementById('search-input');
        let allRecords = []; // Store all records for search
        
        searchToggleBtn.addEventListener('click', function() {
            searchBar.classList.toggle('hidden');
            if (!searchBar.classList.contains('hidden')) {
                searchInput.focus();
            }
        });
        
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const recordItems = document.querySelectorAll('.record-item');
            
            recordItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                    item.style.opacity = '1';
                } else {
                    item.style.display = 'none';
                    item.style.opacity = '0.3';
                }
            });
        });

        // ì´ˆê¸° ìƒíƒœ: ìƒˆë¡œìš´ ê¸°ë¡ ë‚¨ê¸°ê¸° ì„¹ì…˜ ë³´ì´ê³  ì½”ë©˜íŠ¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        let isRecordMode = true; // true: ê¸°ë¡ ëª¨ë“œ, false: ì½”ë©˜íŠ¸ ëª¨ë“œ

        const dailyQuotes = [
            "ì˜¤ëŠ˜ì˜ ì‘ì€ ê¸°ë¡ì´ ë‚´ì¼ì˜ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì˜ ê°ì •ì€ ì†Œì¤‘í•˜ë©°, ê¸°ë¡ë  ê°€ì¹˜ê°€ ìˆìŠµë‹ˆë‹¤.",
            "ì§€ë‚˜ê°„ í•˜ë£¨ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ì§€ë§Œ, ê¸°ë¡ì€ ì˜ì›í•©ë‹ˆë‹¤.",
            "ê°€ì¥ ì–´ë‘ìš´ ë°¤ì— ê°€ì¥ ë°ì€ ë³„ì´ ë¹›ë‚œë‹¤."
        ];
        let currentDailyQuoteIndex = 0;

        function updateDailyQuote() {
            const quoteTextElement = document.getElementById('daily-quote-text');
            if (quoteTextElement) {
                quoteTextElement.innerText = dailyQuotes[currentDailyQuoteIndex];
                currentDailyQuoteIndex = (currentDailyQuoteIndex + 1) % dailyQuotes.length;
            }
        }


        function updateAIComment(allTodayRecords) {
            const aiCommentText = document.getElementById('ai-comment-text');
            const emotionKeywords = document.getElementById('emotion-keywords');
            
            // null ì²´í¬ ì¶”ê°€ - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìš”ì†Œì— ëŒ€í•œ ì•ˆì „í•œ ì²˜ë¦¬
            if (!aiCommentText) {
                console.warn('ai-comment-text element not found');
                return;
            }
            
            if (allTodayRecords.length > 0) {
                aiCommentText.innerText = `ì‚¬ë‘í•˜ëŠ” ì œìë‹˜, ì˜¤ëŠ˜ ë‚¨ê²¨ì£¼ì‹  ì†Œì¤‘í•œ ê¸°ë¡ë“¤ì„ ì½ì—ˆì–´ìš”.
                ì‘ì€ ìˆœê°„ë“¤ì´ ëª¨ì—¬ ì œìë‹˜ì˜ í•˜ë£¨ë¥¼ ì•„ë¦„ë‹µê²Œ ì±„ìš°ê³  ìˆë„¤ìš”.
                ì˜¤ëŠ˜ì˜ ê¸°ë¡ì„ í†µí•´ [ê°ì • í‚¤ì›Œë“œ ì˜ˆì‹œ: ê¸°ì¨, í‰ì˜¨]ì´ ëŠê»´ì§‘ë‹ˆë‹¤.
                ê¾¸ì¤€íˆ ìì‹ ì„ ëŒì•„ë³´ëŠ” ëª¨ìŠµì´ ì°¸ ëŒ€ê²¬í•´ìš”.`;
                
                // emotionKeywordsê°€ ì¡´ì¬í•  ë•Œë§Œ ì„¤ì •
                if (emotionKeywords) {
                    emotionKeywords.innerText = 'ì˜¤ëŠ˜ì˜ ê°ì • í‚¤ì›Œë“œ: #ê¸°ì¨ #í‰ì˜¨ #ëŒ€ê²¬í•¨ #ì¼ìƒ';
                }
            } else {
                aiCommentText.innerText = 'ì•„ì§ ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ì—†ì–´ì„œ ì„ ìƒë‹˜ì˜ ì½”ë©˜íŠ¸ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”. ì²« ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”!';
                
                // emotionKeywordsê°€ ì¡´ì¬í•  ë•Œë§Œ ì„¤ì •
                if (emotionKeywords) {
                    emotionKeywords.innerText = '';
                }
            }
        }

        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ì„¹ì…˜ ê°€ì‹œì„± ë° ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateSectionVisibility() {
            if (isRecordMode) {
                // ê¸°ë¡ ëª¨ë“œ: ìƒˆë¡œìš´ ê¸°ë¡ ì„¹ì…˜ ë³´ì´ê³ , AI ì½”ë©˜íŠ¸ ì„¹ì…˜ ìˆ¨ê¹€
                newRecordSection.classList.remove('hidden');
                saveDiaryBtn.classList.remove('hidden');
                dailyQuoteBox.classList.remove('hidden'); // ê¸°ë¡ ëª¨ë“œì¼ ë•Œ ëª…ì–¸ ë¸”ë¡ í‘œì‹œ
                aiCommentSection.classList.add('hidden');
                aiChatButton.classList.add('hidden'); // AI ì±„íŒ… ë²„íŠ¼ ìˆ¨ê¹€
                // toggleCommentRecordBtn.innerText = 'ì½”ë©˜íŠ¸ ë³´ê¸° (í…ŒìŠ¤íŠ¸ìš©)'; // ì½”ë©˜íŠ¸ë³´ê¸° ë²„íŠ¼ì€ ìˆ¨ê¹€ ì²˜ë¦¬

            } else {
                // ì½”ë©˜íŠ¸ ëª¨ë“œ: AI ì½”ë©˜íŠ¸ ì„¹ì…˜ ë³´ì´ê³ , ìƒˆë¡œìš´ ê¸°ë¡ ì„¹ì…˜ ìˆ¨ê¹€
                newRecordSection.classList.add('hidden');
                saveDiaryBtn.classList.add('hidden');
                dailyQuoteBox.classList.add('hidden'); // ì½”ë©˜íŠ¸ ëª¨ë“œì¼ ë•Œ ëª…ì–¸ ë¸”ë¡ ìˆ¨ê¹€
                aiCommentSection.classList.remove('hidden');
                
                // ì½”ë©˜íŠ¸ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ AI ì±„íŒ… ë²„íŠ¼ í‘œì‹œ
                const allRecords = Array.from(recordsListScrollable.children).filter(el => el.classList.contains('record-item') && el.id !== 'no-records-placeholder');
                if (allRecords.length > 0) { // ì˜ˆì‹œ ê¸°ë¡ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ AI ì½”ë©˜íŠ¸ê°€ ìˆë‹¤ê³  ê°„ì£¼
                    aiChatButton.classList.remove('hidden'); 
                } else {
                    aiChatButton.classList.add('hidden');
                }
                // toggleCommentRecordBtn.innerText = 'ê¸°ë¡ ë‚¨ê¸°ê¸° (í…ŒìŠ¤íŠ¸ìš©)'; // ì½”ë©˜íŠ¸ë³´ê¸° ë²„íŠ¼ì€ ìˆ¨ê¹€ ì²˜ë¦¬
            }
        }

        // ì‹œê°„ í¬ë§·: ì˜¤ì „/ì˜¤í›„ 00:00
        function formatAMPM(date) {
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const isAM = hours < 12;
            let period = isAM ? 'ì˜¤ì „' : 'ì˜¤í›„';
            hours = hours % 12;
            if (hours === 0) hours = 12;
            return `${period} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        // "ìƒê° ê¸°ë¡í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        saveDiaryBtn.addEventListener('click', function() {
            const content = diaryContent.value.trim();
            if (content) {
                // Show loading state
                saveDiaryBtn.disabled = true;
                saveDiaryBtn.textContent = 'ì €ì¥ ì¤‘...';
                
                // Prepare data for API call
                const formData = new FormData();
                formData.append('userId', userId);
                formData.append('content', content);
                formData.append('appliedStamp', 'ì°¸ì˜í–ˆì–´ìš”'); // ê¸°ë³¸ ìŠ¤íƒ¬í”„
                if (selectedEmotion) {
                    formData.append('emotion', selectedEmotion);
                }
                
                // Call backend API
                fetch('/api/diaries', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data); // ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€
                    console.log('Response type:', typeof data);
                    console.log('Response keys:', Object.keys(data));
                    
                    // success í•„ë“œ ë˜ëŠ” isSuccess í•„ë“œ í™•ì¸ (JSON ì§ë ¬í™” ë¬¸ì œ ëŒ€ì‘)
                    const isSuccess = data.success === true || data.isSuccess === true;
                    console.log('Is success:', isSuccess);
                    
                    if (isSuccess) {
                        // Success: Add to UI
                        const now = new Date();
                        const time = formatAMPM(now);
                        
                        const newRecordItem = document.createElement('div');
                        newRecordItem.className = 'record-item';
                        
                        // Include emotion if selected
                        const emotionDisplay = selectedEmotion ? ` <span class="text-lg">${selectedEmotion}</span>` : '';
                        newRecordItem.innerHTML = `<span class="text-[#8F9562] text-sm mr-2">[${time}]</span>${content}${emotionDisplay}`;
                        
                        recordsListScrollable.prepend(newRecordItem); // Add to top of the list

                        diaryContent.value = ''; // Clear input
                        
                        // Reset emotion selection
                        emotionButtons.forEach(b => b.classList.remove('selected'));
                        selectedEmotion = null;
                        
                        noRecordsPlaceholder.classList.add('hidden'); // Hide placeholder if visible

                        const allRecords = Array.from(recordsListScrollable.children).filter(el => el.classList.contains('record-item') && el.id !== 'no-records-placeholder');
                        updateAIComment(allRecords); // AI ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸

                        recordsListScrollable.scrollTop = 0; // ìŠ¤í¬ë¡¤ì„ ìµœìƒë‹¨ìœ¼ë¡œ ì´ë™
                        
                        // Refresh calendar data
                        fetchAndRender();
                        
                        // ===================== NEW EMOTION STATS UPDATE =====================
                        // 2025-01-XX: ì¼ê¸° ì €ì¥ í›„ ê°ì • í†µê³„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                        updateEmotionStats(currentYear, currentMonth);
                        // ===================== END NEW EMOTION STATS UPDATE =====================
                        
                        // Show success message
                        showSuccessMessage('ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        throw new Error(data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('Error saving diary:', error);
                    showErrorMessage('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                })
                .finally(() => {
                    // Reset button state
                    saveDiaryBtn.disabled = false;
                    saveDiaryBtn.textContent = 'ìƒê° ê¸°ë¡í•˜ê¸°';
                });
                
            } else {
                alert('ê¸°ë¡í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        });

        // "ì½”ë©˜íŠ¸/ê¸°ë¡ ì „í™˜" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        toggleCommentRecordBtn.addEventListener('click', function() {
            isRecordMode = !isRecordMode; // ëª¨ë“œ í† ê¸€
            updateSectionVisibility(); // ê°€ì‹œì„± ì—…ë°ì´íŠ¸
            
            // ì½”ë©˜íŠ¸ ëª¨ë“œë¡œ ì „í™˜ ì‹œ, AI ì½”ë©˜íŠ¸ ë‚´ìš© ë‹¤ì‹œ ê³„ì‚°
            if (!isRecordMode) {
                const allRecords = Array.from(recordsListScrollable.children).filter(el => el.classList.contains('record-item') && el.id !== 'no-records-placeholder');
                updateAIComment(allRecords);
            }
        });

        // "AIì™€ ì±„íŒ…í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        aiChatButton.addEventListener('click', function() {
            alert('AI ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤!');
            // ì‹¤ì œ êµ¬í˜„ ì‹œ window.location.href = '/chat'; ë“±ìœ¼ë¡œ í˜ì´ì§€ ì´ë™
        });


        // ì´ˆê¸° ë¡œë“œ ì‹œ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            // ì´ˆê¸° ìƒíƒœëŠ” ê¸°ë¡ ëª¨ë“œë¡œ ì‹œì‘í•˜ë©°, ì½”ë©˜íŠ¸ ë¸”ë¡ì€ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.
            isRecordMode = true; 
            updateSectionVisibility();
            updateDailyQuote(); // ì´ˆê¸° ëª…ì–¸ ì„¤ì •
            setInterval(updateDailyQuote, 10000); // 10ì´ˆë§ˆë‹¤ ëª…ì–¸ ë³€ê²½ (ì„ íƒ ì‚¬í•­)

            // ì´ˆê¸° ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš° placeholder í‘œì‹œ
            const initialRecords = Array.from(recordsListScrollable.children).filter(el => el.classList.contains('record-item') && el.id !== 'no-records-placeholder');
            if (initialRecords.length === 0) {
                noRecordsPlaceholder.classList.remove('hidden');
            } else {
                noRecordsPlaceholder.classList.add('hidden');
            }
            updateAIComment(initialRecords); // ì´ˆê¸° AI ì½”ë©˜íŠ¸ ë‚´ìš© ì„¤ì • (ìˆ¨ê²¨ì ¸ ìˆì–´ë„ ë‚´ìš© ë¯¸ë¦¬ ì¤€ë¹„)
        });

        // --- ë™ì  ë‹¬ë ¥/ì¼ê¸°/ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ ---
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        const userId = /*[[${user != null}]]*/ false ? '[[${user.userId}]]' : 1; // Thymeleafì—ì„œ ìœ ì €ID ì£¼ì…, ì—†ìœ¼ë©´ 1
        let currentDiaries = [];
        let selectedDate = null;

        function renderCalendar(year, month, diaryData) {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            const days = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
            days.forEach(d => {
                const div = document.createElement('div');
                div.className = 'text-center font-medium';
                div.textContent = d;
                calendarGrid.appendChild(div);
            });
            
            // ì›”ìš”ì¼ì´ 0, ì¼ìš”ì¼ì´ 6ì´ ë˜ë„ë¡ ì¡°ì •
            let firstDay = new Date(year, month-1, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1; // ì¼ìš”ì¼(0)ì„ 6ìœ¼ë¡œ, ì›”ìš”ì¼(1)ì„ 0ìœ¼ë¡œ ë³€í™˜
            
            const lastDate = new Date(year, month, 0).getDate();
            const today = new Date();
            
            // ì´ì „ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ ì§œë“¤ ê³„ì‚°
            const prevMonth = month === 1 ? 12 : month - 1;
            const prevYear = month === 1 ? year - 1 : year;
            const prevMonthLastDate = new Date(prevYear, prevMonth, 0).getDate();
            
            // ì´ì „ ë‹¬ì˜ ë‚ ì§œë“¤ì„ íë¦¿í•˜ê²Œ í‘œì‹œ
            for(let i=0; i<firstDay; i++) {
                const prevDate = prevMonthLastDate - firstDay + i + 1;
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                cell.style.opacity = '0.3';
                cell.style.background = '#f8f8f8';
                cell.style.cursor = 'default';
                cell.style.pointerEvents = 'none';
                
                const numSpan = document.createElement('span');
                numSpan.className = 'date-number';
                // ì´ì „ ë‹¬ì˜ ìœ íš¨í•œ ë‚ ì§œ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì²´í¬
                if (prevDate > 0 && prevDate <= prevMonthLastDate) {
                    numSpan.textContent = prevDate;
                } else {
                    numSpan.textContent = ''; // ë¹ˆ ì¹¸ìœ¼ë¡œ í‘œì‹œ
                }
                // ë””ë²„ê¹…ìš© ì½˜ì†” ë¡œê·¸ (ë‚˜ì¤‘ì— ì œê±°)
                console.log(`prevDate: ${prevDate}, prevMonthLastDate: ${prevMonthLastDate}, firstDay: ${firstDay}, i: ${i}`);
                numSpan.style.color = '#999';
                cell.appendChild(numSpan);
                
                calendarGrid.appendChild(cell);
            }
            
            // í˜„ì¬ ë‹¬ì˜ ë‚ ì§œë“¤
            for(let d=1; d<=lastDate; d++) {
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                // ë‚ ì§œ ìˆ«ì ì¤‘ì•™ í‘œì‹œ
                const numSpan = document.createElement('span');
                numSpan.className = 'date-number';
                numSpan.textContent = d;
                cell.appendChild(numSpan);
                // ì¼ê¸° ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                const diary = diaryData.find(item => new Date(item.createdAt).getDate() === d);
                if (diary) {
                    cell.classList.add('has-diary');
                    // appliedStampëŠ” í¬ì¸íŠ¸ ê³„ì‚°ìš©ì´ë¯€ë¡œ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ, ì°¸ì˜í–ˆì–´ìš” ìŠ¤íƒ¬í”„ë§Œ ê³ ì • í‘œì‹œ
                    const img = document.createElement('img');
                    img.dataset.src = '/images/ì°¸ì˜í–ˆì–´ìš”.png';
                    img.alt = 'ì°¸ì˜í–ˆì–´ìš” ìŠ¤íƒ¬í”„';
                    img.className = 'stamp-image-calendar loading';
                    cell.appendChild(img);
                    
                    // Observe for lazy loading
                    imageObserver.observe(img);
                    
                    if (diary.emotion) {
                        const span = document.createElement('span');
                        span.className = 'emotion-icon';
                        span.textContent = diary.emotion;
                        cell.appendChild(span);
                    }
                }
                if (year === today.getFullYear() && month === today.getMonth()+1 && d === today.getDate()) {
                    cell.classList.add('today');
                }
                const isFuture = (year > today.getFullYear()) ||
                    (year === today.getFullYear() && month > today.getMonth()+1) ||
                    (year === today.getFullYear() && month === today.getMonth()+1 && d > today.getDate());
                if (isFuture) {
                    cell.style.pointerEvents = 'none';
                    cell.style.opacity = '0.5';
                    cell.style.background = '#f3f3f3';
                } else {
                    cell.onclick = function() {
                        selectDiaryDate(year, month, d, diaryData);
                    };
                }
                calendarGrid.appendChild(cell);
            }
            
            // ë‹¤ìŒ ë‹¬ì˜ ë‚ ì§œë“¤ì„ íë¦¿í•˜ê²Œ í‘œì‹œ
            const totalCells = 35; // 5ì£¼ x 7ì¼ = 35ê°œ ì…€
            const filledCells = firstDay + lastDate;
            const remainingCells = totalCells - filledCells;
            
            for(let i=1; i<=remainingCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                cell.style.opacity = '0.3';
                cell.style.background = '#f8f8f8';
                cell.style.cursor = 'default';
                cell.style.pointerEvents = 'none';
                
                const numSpan = document.createElement('span');
                numSpan.className = 'date-number';
                numSpan.textContent = i;
                numSpan.style.color = '#999';
                cell.appendChild(numSpan);
                
                calendarGrid.appendChild(cell);
            }
        }
        function selectDiaryDate(year, month, day, diaryData) {
            // Remove previous selection
            const prevSelected = document.querySelector('.date-cell.selected');
            if (prevSelected) {
                prevSelected.classList.remove('selected');
            }
            
            selectedDate = new Date(year, month-1, day);
            
            // Add selection to current date
            const currentCells = document.querySelectorAll('.date-cell');
            currentCells.forEach(cell => {
                const cellDate = cell.querySelector('.date-number');
                if (cellDate && cellDate.textContent == day) {
                    cell.classList.add('selected');
                }
            });
            
            // í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ê¸°ë¡(ì‹œê°„ë³„ ë“±) í•„í„°ë§
            const records = diaryData.filter(item => {
                const d = new Date(item.createdAt);
                return d.getFullYear() === year && d.getMonth()+1 === month && d.getDate() === day;
            });
            renderRecordsList(records, year, month, day);
        }
        function renderRecordsList(records, year, month, day) {
            const recordsList = document.getElementById('today-records-list-scrollable');
            recordsList.innerHTML = '';
            if (records.length === 0) {
                recordsList.innerHTML = `<p class='text-[#8F9562] text-center py-4'>ì´ ë‚ ì§œì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>`;
            } else {
                records.slice().reverse().forEach(rec => {
                    const time = formatAMPM(new Date(rec.createdAt));
                    recordsList.innerHTML += `<div class='record-item'>
                        <span class='text-[#8F9562] text-sm mr-2'>[${time}]</span>
                        <span>${rec.content}</span>
                        <span class='ml-2'>${rec.emotion ? 'ê°ì •: '+rec.emotion : ''}</span>
                        <!-- appliedStamp ì´ë¯¸ì§€ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ -->
                    </div>`;
                });
            }
            // ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ë‚ ì§œ í‘œì‹œ(ì„ íƒì )
            const header = document.querySelector('.right-section-container h2');
            if (header) header.textContent = `${year}ë…„ ${month}ì›” ${day}ì¼ ê¸°ë¡`;

            // ì˜¤ëŠ˜ ë‚ ì§œë©´ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth()+1 && day === today.getDate()) {
                setTimeout(() => { recordsList.scrollTop = recordsList.scrollHeight; }, 0);
            }

            // ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œë©´ ê¸°ë¡ ì…ë ¥ì°½ ìˆ¨ê¸°ê³  ì½”ë©˜íŠ¸ë§Œ ë³´ì´ê²Œ, ì¼ê¸° ì—†ëŠ” ë‚ ì€ ì½”ë©˜íŠ¸ ìˆ¨ê¹€
            const isPast = (year < today.getFullYear()) ||
                (year === today.getFullYear() && month < today.getMonth()+1) ||
                (year === today.getFullYear() && month === today.getMonth()+1 && day < today.getDate());
            const newRecordSection = document.getElementById('new-record-section');
            const saveDiaryBtn = document.getElementById('save-diary-btn');
            const aiCommentSection = document.getElementById('ai-comment-section');
            if (isPast) {
                if (newRecordSection) newRecordSection.classList.add('hidden');
                if (saveDiaryBtn) saveDiaryBtn.classList.add('hidden');
                if (aiCommentSection) {
                    if (records.length > 0) aiCommentSection.classList.remove('hidden');
                    else aiCommentSection.classList.add('hidden');
                }
            } else {
                if (newRecordSection) newRecordSection.classList.remove('hidden');
                if (saveDiaryBtn) saveDiaryBtn.classList.remove('hidden');
                if (aiCommentSection) aiCommentSection.classList.add('hidden');
            }
        }
        document.getElementById('prev-month-btn').onclick = function() {
            if (--currentMonth < 1) { currentMonth = 12; currentYear--; }
            fetchAndRender();
        };
        document.getElementById('next-month-btn').onclick = function() {
            if (++currentMonth > 12) { currentMonth = 1; currentYear++; }
            fetchAndRender();
        };
        function fetchAndRender() {
            // Show loading state
            isLoading = true;
            showCalendarSkeleton();
            showRecordsSkeleton();
            showWeeklyReportsSkeleton();
            
            document.getElementById('calendar-title').textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
            
            fetch(`/api/diaries?userId=${userId}&year=${currentYear}&month=${currentMonth}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    currentDiaries = data.data || [];
                    renderCalendar(currentYear, currentMonth, currentDiaries);
                    updateCalendarSummary(currentDiaries, currentYear, currentMonth);
                    renderWeeklyReports(currentDiaries, currentYear, currentMonth);
                    
                    // ===================== NEW EMOTION STATS CALL =====================
                    // 2025-01-XX: ê°ì • í†µê³„ API í˜¸ì¶œ ì¶”ê°€
                    updateEmotionStats(currentYear, currentMonth);
                    // ===================== END NEW EMOTION STATS CALL =====================
                    
                    // ê¸°ë³¸: ì˜¤ëŠ˜ ë‚ ì§œì˜ ê¸°ë¡ í‘œì‹œ
                    const today = new Date();
                    if (currentYear === today.getFullYear() && currentMonth === today.getMonth()+1) {
                        selectDiaryDate(currentYear, currentMonth, today.getDate(), currentDiaries);
                    } else {
                        renderRecordsList([], currentYear, currentMonth, 1);
                    }
                    isLoading = false;
                })
                .catch(error => {
                    console.error('Error fetching diary data:', error);
                    showErrorMessage('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    isLoading = false;
                });
        }

        // ì£¼ì°¨ë³„ ê°ì • ë¦¬í¬íŠ¸ ë™ì  ìƒì„±
        // ì£¼ì°¨ë³„ ë¦¬í¬íŠ¸ ìˆ˜ì •ë¶€ë¶„ì…ë‹ˆë‹¤! ìˆ˜ë¯¼ë‹˜ì°¸ê³ !
        function renderWeeklyReports(diaryData, year, month) {
            const reportsList = document.getElementById('weekly-reports-list');
            reportsList.innerHTML = '';
            
            // 1. í•´ë‹¹ ì›” 1ì¼ì´ ì†í•œ ì£¼ì˜ ì›”ìš”ì¼ ì°¾ê¸° (ì „ì›” í¬í•¨)
            const firstDate = new Date(year, month-1, 1);
            let firstMonday = new Date(firstDate);
            let dayOfWeek = firstDate.getDay(); // 0:ì¼, 1:ì›”, ... 6:í† 
            
            // 1ì¼ì´ ì›”ìš”ì¼ì´ ì•„ë‹ˆë©´, ê·¸ ì£¼ì˜ ì›”ìš”ì¼ì„ ì „ì›”ë¡œ ì´ë™í•´ì„œ ì°¾ìŒ
            if (dayOfWeek !== 1) {
                // 1ì¼ì—ì„œ dayOfWeek-1 ë§Œí¼ ë¹¼ë©´ ê·¸ ì£¼ ì›”ìš”ì¼
                let diff = (dayOfWeek === 0) ? 6 : (dayOfWeek - 1);
                firstMonday.setDate(firstDate.getDate() - diff);
            }
            
            // 2. ê° ì£¼ì°¨ë³„ë¡œ ì›”~ì¼ êµ¬ê°„ ê³„ì‚° (ì „ì›” í¬í•¨í•˜ì—¬ ì „ì²´ ì£¼ì°¨ í‘œì‹œ)
            const lastDateNum = new Date(year, month, 0).getDate();
            let weekStart = new Date(firstMonday);
            let weekIdx = 1;
            
            while (true) {
                let weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                // ì£¼ì°¨ì˜ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼
                let startDay = weekStart.getDate();
                let endDay = weekEnd.getDate();
                let startMonth = weekStart.getMonth() + 1;
                let endMonth = weekEnd.getMonth() + 1;
                let startYear = weekStart.getFullYear();
                let endYear = weekEnd.getFullYear();
                
                // ì£¼ì°¨ê°€ í•´ë‹¹ ì›”ì— ì†í•˜ëŠ”ì§€ í™•ì¸ (ì‹œì‘ì¼ì´ë‚˜ ì¢…ë£Œì¼ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹ ì›”ì— ì†í•˜ë©´)
                if (startMonth === month || endMonth === month) {
                    // ì£¼ì°¨ì˜ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼
                    let startDay = weekStart.getDate();
                    let endDay = weekEnd.getDate();
                    let startMonth = weekStart.getMonth() + 1;
                    let endMonth = weekEnd.getMonth() + 1;
                    let startYear = weekStart.getFullYear();
                    let endYear = weekEnd.getFullYear();
                    
                    // ì¼ìš”ì¼ì´ í¬í•¨ëœ ì›”ì„ ê¸°ì¤€ìœ¼ë¡œ ë¦¬í¬íŠ¸ ì›” ê²°ì •
                    let reportMonth = endMonth; // ì¼ìš”ì¼ì´ ìˆëŠ” ì›”
                    let reportYear = endYear;
                    
                    // í•´ë‹¹ ì›”ì˜ ëª‡ ë²ˆì§¸ ì£¼ì°¨ì¸ì§€ ê³„ì‚°
                    let reportWeekIdx = 1;
                    let tempWeekStart = new Date(reportYear, reportMonth-1, 1);
                    let tempDayOfWeek = tempWeekStart.getDay();
                    
                    // í•´ë‹¹ ì›” 1ì¼ì´ ì†í•œ ì£¼ì˜ ì›”ìš”ì¼ ì°¾ê¸°
                    if (tempDayOfWeek !== 1) {
                        let diff = (tempDayOfWeek === 0) ? 6 : (tempDayOfWeek - 1);
                        tempWeekStart.setDate(tempWeekStart.getDate() - diff);
                    }
                    
                    // í˜„ì¬ ì£¼ì°¨ê°€ í•´ë‹¹ ì›”ì˜ ëª‡ ë²ˆì§¸ ì£¼ì°¨ì¸ì§€ ê³„ì‚°
                    while (tempWeekStart.getTime() < weekEnd.getTime()) {
                        tempWeekStart.setDate(tempWeekStart.getDate() + 7);
                        if (tempWeekStart.getTime() <= weekEnd.getTime()) {
                            reportWeekIdx++;
                        }
                    }
                    
                    // ì¼ìš”ì¼ì´ í¬í•¨ëœ ì›”ì´ í˜„ì¬ ë³´ê³  ìˆëŠ” ì›”ê³¼ ê°™ì€ ê²½ìš°ì—ë§Œ ë¦¬í¬íŠ¸ í‘œì‹œ
                    if (reportMonth === month) {
                        // í…ìŠ¤íŠ¸ ì˜ˆ: 7ì›” 1ì£¼ì°¨ ë¦¬í¬íŠ¸ (6/30 ~ 7/6)
                        let weekLabel = `${reportMonth}ì›” ${reportWeekIdx}ì£¼ì°¨ ë¦¬í¬íŠ¸ (${startMonth}/${startDay} ~ ${endMonth}/${endDay})`;
                        
                        // ë¦¬í¬íŠ¸ ë¸”ë¡ ìƒì„±
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between bg-white p-4 rounded-lg border border-[#B87B5C]';
                        const span = document.createElement('span');
                        span.className = 'text-[#495235] font-medium';
                        span.textContent = weekLabel;
                        div.appendChild(span);
                        const btn = document.createElement('button');
                        btn.className = 'btn-nav bg-[#8F9562] hover:bg-[#495235] text-sm';
                        btn.textContent = 'ë¦¬í¬íŠ¸ ë³´ê¸°';
                        btn.onclick = () => alert(`${weekLabel} í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤!`);
                        div.appendChild(btn);
                        reportsList.appendChild(div);
                    }
                }
                
                // ë‹¤ìŒ ì£¼ë¡œ ì´ë™
                weekStart.setDate(weekStart.getDate() + 7);
                weekIdx++;
                
                // ì£¼ì°¨ ì‹œì‘ì¼ì´ í•´ë‹¹ ì›”ì„ ì™„ì „íˆ ë²—ì–´ë‚˜ë©´ ì¢…ë£Œ
                if (weekStart.getMonth() > month-1) break;
            }
        }
        // ë‹¬ë ¥ ìš”ì•½(ì´ë²ˆ ë‹¬ ì¼ê¸°, ì—°ì† ê¸°ë¡) ê°±ì‹  í•¨ìˆ˜
        function updateCalendarSummary(diaryData, year, month) {
            // 1. ë‚ ì§œë³„ë¡œ ì¼ê¸° ì‘ì„± ì—¬ë¶€ ì§‘ê³„
            const daysWithDiary = new Set();
            diaryData.forEach(item => {
                const d = new Date(item.createdAt);
                if (d.getFullYear() === year && d.getMonth()+1 === month) {
                    daysWithDiary.add(d.getDate());
                }
            });
            const diaryCount = daysWithDiary.size;

            // 2. ì—°ì† ê¸°ë¡ ê³„ì‚°
            // ë‚ ì§œ ë°°ì—´ë¡œ ë³€í™˜ í›„ ì •ë ¬
            const sortedDays = Array.from(daysWithDiary).sort((a, b) => a - b);
            let maxStreak = 0, curStreak = 0, prevDay = null;
            sortedDays.forEach(day => {
                if (prevDay !== null && day === prevDay + 1) {
                    curStreak++;
                } else {
                    curStreak = 1;
                }
                if (curStreak > maxStreak) maxStreak = curStreak;
                prevDay = day;
            });

            // 3. DOMì— ë°˜ì˜
            const summary = document.getElementById('calendar-summary');
            if (summary) {
                summary.textContent = `ì´ë²ˆ ë‹¬ ì¼ê¸°: ${diaryCount}ì¼ ì‘ì„± | ì—°ì† ê¸°ë¡: ${maxStreak}ì¼`;
            }
        }
        
        // ===================== NEW EMOTION STATS FUNCTION =====================
        // 2025-01-XX: ì›”ë³„ ê°ì • í†µê³„ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€
        // ì£¼ìš” ê°ì • í‘œì‹œ í•¨ìˆ˜
        function updateEmotionStats(year, month) {
            fetch(`/api/diaries/emotions?userId=${userId}&year=${year}&month=${month}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Emotion Stats Response:', data);
                    
                    if (data.success && data.data) {
                        const emotionStats = data.data;
                        const topEmotions = emotionStats.topEmotions || [];
                        
                        // ì£¼ìš” ê°ì • í‘œì‹œ ì—…ë°ì´íŠ¸
                        const emotionsElement = document.getElementById('calendar-emotions');
                        if (emotionsElement) {
                            if (topEmotions.length > 0) {
                                const emotionDisplay = topEmotions.map(item => 
                                    `<span class="emotion-stat-item">
                                        <span>${item.emotion}</span>
                                        <span class="emotion-stat-count">${item.count}íšŒ</span>
                                    </span>`
                                ).join('');
                                emotionsElement.innerHTML = `ì£¼ìš” ê°ì •: ${emotionDisplay}`;
                            } else {
                                emotionsElement.textContent = 'ì£¼ìš” ê°ì •: ê¸°ë¡ëœ ê°ì •ì´ ì—†ìŠµë‹ˆë‹¤';
                            }
                        }
                    } else {
                        console.warn('Failed to get emotion stats:', data.message);
                        const emotionsElement = document.getElementById('calendar-emotions');
                        if (emotionsElement) {
                            emotionsElement.textContent = 'ì£¼ìš” ê°ì •: ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching emotion stats:', error);
                    const emotionsElement = document.getElementById('calendar-emotions');
                    if (emotionsElement) {
                        emotionsElement.textContent = 'ì£¼ìš” ê°ì •: ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                    }
                });
        }
        // ===================== END NEW EMOTION STATS FUNCTION =====================
        // ìµœì´ˆ ë Œë”ë§
        fetchAndRender();
    </script>
</body>
</html>