<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인생, 쓰다 - 일기 기록 및 달력</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #F4DDB8; /* WHEAT */
            color: #495235; /* DARK FERN */
        }
        .container-card {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #B87B5C; /* BROWN SUGAR */
        }
        .section-title {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 600; /* font-semibold */
            color: #90533B; /* CHESTNUT */
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #B87B5C; /* BROWN SUGAR */
            padding-bottom: 0.5rem;
        }
        .info-item { /* 기존 CSS에서 사용된 info-item 스타일 유지 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #E0E0E0;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 500;
            color: #495235;
        }
        .info-value {
            color: #8F9562;
            font-weight: 400;
        }
        /* Common button styles */
        .btn-main {
            background-color: #DA983C; /* HARVEST GOLD */
            color: white;
            padding: 1rem 2.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.25rem;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-main:hover {
            background-color: #90533B; /* CHESTNUT */
            transform: translateY(-2px);
        }
        .btn-nav { /* for calendar nav */
            background-color: #B87B5C;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-nav:hover {
            background-color: #90533B;
        }
        /* New toggle button style */
        .btn-toggle {
            background-color: #8F9562; /* MOSS GREEN */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        }
        .btn-toggle:hover {
            background-color: #495235; /* DARK FERN */
        }
        /* AI Chat button moved to action area */
        .btn-ai-chat-action {
            background-color: #8F9562; /* MOSS GREEN */
            color: white;
            padding: 1rem 2.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.25rem;
            transition: background-color 0.2s ease-in-out;
            width: 100%; /* 너비를 꽉 채우도록 */
        }
        .btn-ai-chat-action:hover {
            background-color: #495235; /* DARK FERN */
        }

        /* Input field style */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #B87B5C;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #495235;
            background-color: white;
        }
        .input-field:focus {
            outline: none;
            border-color: #DA983C;
            box-shadow: 0 0 0 2px rgba(218, 152, 60, 0.2);
        }

        /* AI Comment Box */
        .ai-comment-box {
            background-color: #F4DDB8;
            border: 1px solid #8F9562;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: visible;
            display: flex; /* 내부 요소들을 flex로 정렬 */
            flex-direction: column; /* 세로로 정렬 */
            flex-shrink: 0; /* 이 요소는 줄어들지 않음 */
        }
        .stamp-image-comment {
            position: absolute;
            top: -30px;
            right: -30px;
            width: 120px;
            height: 120px;
            transform: rotate(10deg);
            opacity: 0.85;
            z-index: 10;
        }
        .record-item {
            background-color: white;
            border: 1px solid #B87B5C;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            color: #495235;
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            height: 380px; /* 이 값은 달력 내용과 여백에 따라 조정될 수 있습니다. */
            flex-shrink: 0; /* 부모 flex 컨테이너 내에서 줄어들지 않도록 함 */
        }
        .date-cell {
            background-color: white;
            border: 1px solid #B87B5C;
            border-radius: 0.75rem;
            padding: 0.75rem;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            position: relative;
            overflow: hidden;
            color: #495235;
        }
        .date-cell:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .date-cell.has-diary {
            background-color: #F4DDB8;
            border-color: #8F9562;
        }
        .date-cell.today {
            border: 2px solid #DA983C;
            font-weight: bold;
        }
        .stamp-image-calendar {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            transform: translate(-50%, -50%) rotate(10deg);
            opacity: 1;
            filter: drop-shadow(0 2px 6px rgba(60,40,120,0.18)) contrast(1.15) brightness(1.1);
            pointer-events: none;
            z-index: 2;
        }
        .date-cell .date-number {
            position: relative;
            z-index: 3;
            font-weight: bold;
            font-size: 1.1em;
        }
        .emotion-icon {
            font-size: 1.3rem;
            margin-top: 0.3rem;
            color: #90533B;
        }
        /* Left Section: Calendar container */
        .left-section-container {
            flex-grow: 1; 
            min-height: 550px; 
            height: 800px; /* 고정 높이 설정 (스크린샷 비율에 맞춰 조정) */
            overflow-y: auto; /* 리포트 목록이 많아지면 스크롤되도록 */
        }

        /* Right Section container */
        .right-section-container {
            flex-grow: 1; /* 남은 공간을 채우도록 성장 */
            min-height: 550px; /* 왼쪽과 비슷한 최소 높이 보장 */
            height: 800px; /* 왼쪽과 동일하게 고정 높이 설정 */
        }
        /* 스크롤 가능한 기록 목록의 직접적인 부모를 지정 */
        .records-list-wrapper {
            max-height: 250px; /* 초기 높이 제한. 이 값은 디자인에 따라 조정하세요. */
            overflow-y: auto; /* 내부의 기록들만 스크롤되도록 */
            padding: 1rem; /* 상자처럼 패딩 추가 */
            padding-bottom: 1.5rem; /* 하단 패딩을 더 늘림 */
            border: 1px solid #B87B5C; /* 얇은 테두리 추가 */
            border-radius: 0.5rem; /* 모서리 둥글게 */
            margin-bottom: 1rem; /* 하단 여백 추가 */
            flex-shrink: 0; /* 이 래퍼가 줄어들지 않도록 함 */
            background-color: white; /* 배경색도 하얀색으로 통일 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* 은은한 그림자 */
        }
        /* 오늘의 명언 블록 스타일 */
        .daily-quote-box {
            background-color: #F4DDB8; /* WHEAT */
            border: 1px dashed #DA983C; /* HARVEST GOLD */
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem; /* 새로운 기록 남기기 섹션과의 간격 */
            text-align: center;
            font-style: italic;
            color: #90533B; /* CHESTNUT */
            line-height: 1.5;
            font-size: 1.1rem;
        }
        .modal-bg {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.3); z-index: 50; display: flex; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; border-radius: 1rem; padding: 2rem; min-width: 350px; max-width: 90vw;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; color: #B87B5C; cursor: pointer;
        }
        .emotion-icon-modal { font-size: 2rem; margin-right: 0.5rem; }
        .stamp-image-modal { width: 60px; height: 60px; margin-left: 1rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4 sm:px-6 lg:px-8">
    <header class="w-full max-w-4xl text-center mb-10">
        <h1 class="text-5xl font-bold text-[#90533B] mb-2">인생, 쓰다</h1>
        <p class="text-2xl text-[#495235]">일기 기록 및 달력</p>
        <!-- 유저 닉네임 표시 (테스트용: 쿼리 파라미터로 전달 시) -->
        <div th:if="${user != null}" class="mt-2 text-lg text-[#8F9562] font-semibold">
            환영합니다, <span th:text="${user.userNickname}"></span>님!
        </div>
    </header>

    <section id="diary-calendar-page-section" class="w-full max-w-5xl flex flex-col lg:flex-row gap-8 py-10">
        <div class="lg:w-1/2 container-card flex flex-col left-section-container">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <button id="prev-month-btn" class="btn-nav">&lt; 이전 달</button>
                <h2 id="calendar-title" class="text-3xl font-semibold text-[#90533B]">2025년 7월</h2>
                <button id="next-month-btn" class="btn-nav">다음 달 &gt;</button>
            </div>
            <div id="calendar-grid" class="calendar-grid mb-4"></div>
            <div class="text-center text-base text-[#8F9562] mt-4 flex-shrink-0">
                <p id="calendar-summary">이번 달 일기: 0일 작성 | 연속 기록: 0일</p>
                <p id="calendar-emotions">주요 감정: -</p>
            </div>
            <div class="mt-8 flex-grow overflow-y-auto">
                <h3 class="text-xl font-semibold text-[#90533B] mb-4">주차별 감정 리포트</h3>
                <div id="weekly-reports-list" class="space-y-3"></div>
            </div>
        </div>

        <div class="lg:w-1/2 container-card flex flex-col right-section-container"> 
            <div class="mb-4 flex-shrink-0"> <h2 class="block text-xl font-semibold text-[#90533B] mb-3">오늘의 짧은 기록들</h2>
                <div class="records-list-wrapper"> <div id="today-records-list-scrollable" class="space-y-2"> <div class="record-item">
                            <span class="text-[#8F9562] text-sm mr-2">[10:30]</span>
                            오늘 아침 햇살이 너무 좋아서 기분 좋게 일어났어요.
                        </div>
                        <div class="record-item">
                            <span class="text-[#8F9562] text-sm mr-2">[14:15]</span>
                            점심으로 맛있는 파스타를 먹었는데, 정말 행복했어요!
                        </div>
                        <div class="record-item">
                            <span class="text-[#8F9562] text-sm mr-2">[16:00]</span>
                            오후에는 친구와 카페에서 수다를 떨었는데, 즐거웠어요!
                        </div>
                        <div class="record-item">
                            <span class="text-[#8F9562] text-sm mr-2">[18:30]</span>
                            저녁으로 간단하게 샐러드를 먹었어요. 건강한 느낌!
                        </div>
                        <div class="record-item">
                            <span class="text-[#8F9562] text-sm mr-2">[20:00]</span>
                            좋아하는 드라마를 보면서 하루를 마무리하는 중입니다.
                        </div>
                        <div class="record-item">
                            <span class="text-[#8F9562] text-sm mr-2">[21:00]</span>
                            새로운 책을 읽기 시작했는데, 내용이 정말 흥미로워요!
                        </div>
                        <div class="record-item">
                            <span class="text-[#8F9562] text-sm mr-2">[22:30]</span>
                            내일 일정을 정리하며 잠자리에 들 준비를 합니다.
                        </div>
                        <p id="no-records-placeholder" class="text-[#8F9562] text-center py-4 hidden">아직 오늘의 기록이 없어요. 첫 기록을 남겨보세요!</p>
                    </div>
                </div>
            </div>

            <div class="daily-quote-box mb-8 flex-shrink-0">
                <p id="daily-quote-text">"당신의 작은 노력이 모여 큰 변화를 만듭니다."</p>
                <p class="text-sm mt-2">- 알 수 없는 작가 -</p>
            </div>

            <div id="ai-comment-section" class="ai-comment-box mb-8 flex-shrink-0 hidden">
                <img src="/images/참잘했어요.png" alt="참잘했어요 스탬프" class="stamp-image-comment">
                <h3 class="text-2xl font-semibold text-[#90533B] mb-4">선생님의 따뜻한 코멘트</h3>
                <p id="ai-comment-text" class="text-[#495235] leading-relaxed text-lg">
                    사랑하는 제자님, 오늘 남겨주신 소중한 기록들을 읽었어요.
                    작은 순간들이 모여 제자님의 하루를 아름답게 채우고 있네요.
                    오늘의 기록을 통해 [감정 키워드 예시: 기쁨, 평온]이 느껴집니다.
                    꾸준히 자신을 돌아보는 모습이 참 대견해요.
                </p>
            </div>

            <div id="new-record-section" class="mt-auto flex-shrink-0"> <label for="diary-content" class="block text-xl font-semibold text-[#90533B] mb-3">새로운 기록 남기기</label>
                <textarea id="diary-content" rows="4" class="w-full input-field resize-y" placeholder="지금 당신의 생각이나 감정을 한두 줄로 자유롭게 기록해주세요."></textarea>
            </div>
            
            <div class="flex flex-col gap-4 mt-6 flex-shrink-0"> <button id="ai-chat-button" class="btn-ai-chat-action hidden"> AI와 채팅하기
                </button>
                <div class="flex justify-center items-center gap-4"> <button id="save-diary-btn" class="btn-main flex-grow"> 생각 기록하기
                    </button>
                    <button id="toggle-comment-record-btn" class="btn-toggle">
                        코멘트 보기 (테스트용)
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- 일기 상세/작성 모달 -->
    <div id="diary-modal" class="modal-bg" style="display:none;">
        <div class="modal-box relative">
            <span class="modal-close" onclick="closeDiaryModal()">&times;</span>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        // --- Combined Diary/Calendar Page Scripts ---
        const aiCommentSection = document.getElementById('ai-comment-section');
        const newRecordSection = document.getElementById('new-record-section');
        const toggleCommentRecordBtn = document.getElementById('toggle-comment-record-btn');
        // 코멘트보기 버튼은 주석처리/숨김 처리
        if (toggleCommentRecordBtn) toggleCommentRecordBtn.style.display = 'none';
        const recordsListScrollable = document.getElementById('today-records-list-scrollable');
        const noRecordsPlaceholder = document.getElementById('no-records-placeholder');
        const saveDiaryBtn = document.getElementById('save-diary-btn');
        const diaryContent = document.getElementById('diary-content');
        const aiChatButton = document.getElementById('ai-chat-button'); // AI 채팅 버튼
        const dailyQuoteBox = document.querySelector('.daily-quote-box'); // 오늘의 명언 블록

        // 초기 상태: 새로운 기록 남기기 섹션 보이고 코멘트 섹션 숨기기
        let isRecordMode = true; // true: 기록 모드, false: 코멘트 모드

        const dailyQuotes = [
            "오늘의 작은 기록이 내일의 큰 변화를 만듭니다.",
            "당신의 감정은 소중하며, 기록될 가치가 있습니다.",
            "지나간 하루는 되돌릴 수 없지만, 기록은 영원합니다.",
            "가장 어두운 밤에 가장 밝은 별이 빛난다."
        ];
        let currentDailyQuoteIndex = 0;

        function updateDailyQuote() {
            const quoteTextElement = document.getElementById('daily-quote-text');
            if (quoteTextElement) {
                quoteTextElement.innerText = dailyQuotes[currentDailyQuoteIndex];
                currentDailyQuoteIndex = (currentDailyQuoteIndex + 1) % dailyQuotes.length;
            }
        }


        function updateAIComment(allTodayRecords) {
            const aiCommentText = document.getElementById('ai-comment-text');
            const emotionKeywords = document.getElementById('emotion-keywords');
            
            if (allTodayRecords.length > 0) {
                aiCommentText.innerText = `사랑하는 제자님, 오늘 남겨주신 소중한 기록들을 읽었어요.
                작은 순간들이 모여 제자님의 하루를 아름답게 채우고 있네요.
                오늘의 기록을 통해 [감정 키워드 예시: 기쁨, 평온]이 느껴집니다.
                꾸준히 자신을 돌아보는 모습이 참 대견해요.`;
                emotionKeywords.innerText = '오늘의 감정 키워드: #기쁨 #평온 #대견함 #일상';
            } else {
                aiCommentText.innerText = '아직 오늘의 기록이 없어서 선생님의 코멘트가 준비되지 않았어요. 첫 기록을 남겨보세요!';
                emotionKeywords.innerText = '';
            }
        }

        // 현재 모드에 따라 섹션 가시성 및 버튼 텍스트 업데이트
        function updateSectionVisibility() {
            if (isRecordMode) {
                // 기록 모드: 새로운 기록 섹션 보이고, AI 코멘트 섹션 숨김
                newRecordSection.classList.remove('hidden');
                saveDiaryBtn.classList.remove('hidden');
                dailyQuoteBox.classList.remove('hidden'); // 기록 모드일 때 명언 블록 표시
                aiCommentSection.classList.add('hidden');
                aiChatButton.classList.add('hidden'); // AI 채팅 버튼 숨김
                // toggleCommentRecordBtn.innerText = '코멘트 보기 (테스트용)'; // 코멘트보기 버튼은 숨김 처리

            } else {
                // 코멘트 모드: AI 코멘트 섹션 보이고, 새로운 기록 섹션 숨김
                newRecordSection.classList.add('hidden');
                saveDiaryBtn.classList.add('hidden');
                dailyQuoteBox.classList.add('hidden'); // 코멘트 모드일 때 명언 블록 숨김
                aiCommentSection.classList.remove('hidden');
                
                // 코멘트가 있는 경우에만 AI 채팅 버튼 표시
                const allRecords = Array.from(recordsListScrollable.children).filter(el => el.classList.contains('record-item') && el.id !== 'no-records-placeholder');
                if (allRecords.length > 0) { // 예시 기록이 하나라도 있으면 AI 코멘트가 있다고 간주
                    aiChatButton.classList.remove('hidden'); 
                } else {
                    aiChatButton.classList.add('hidden');
                }
                // toggleCommentRecordBtn.innerText = '기록 남기기 (테스트용)'; // 코멘트보기 버튼은 숨김 처리
            }
        }

        // 시간 포맷: 오전/오후 00:00
        function formatAMPM(date) {
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const isAM = hours < 12;
            let period = isAM ? '오전' : '오후';
            hours = hours % 12;
            if (hours === 0) hours = 12;
            return `${period} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        // "생각 기록하기" 버튼 클릭 이벤트
        saveDiaryBtn.addEventListener('click', function() {
            const content = diaryContent.value.trim();
            if (content) {
                const now = new Date();
                const time = formatAMPM(now);
                
                const newRecordItem = document.createElement('div');
                newRecordItem.className = 'record-item';
                newRecordItem.innerHTML = `<span class="text-[#8F9562] text-sm mr-2">[${time}]</span>${content}`;
                recordsListScrollable.prepend(newRecordItem); // Add to top of the list

                diaryContent.value = ''; // Clear input
                noRecordsPlaceholder.classList.add('hidden'); // Hide placeholder if visible

                const allRecords = Array.from(recordsListScrollable.children).filter(el => el.classList.contains('record-item') && el.id !== 'no-records-placeholder');
                updateAIComment(allRecords); // AI 코멘트 업데이트

                recordsListScrollable.scrollTop = 0; // 스크롤을 최상단으로 이동
                
            } else {
                alert('기록할 내용을 입력해주세요.');
            }
        });

        // "코멘트/기록 전환" 버튼 클릭 이벤트
        toggleCommentRecordBtn.addEventListener('click', function() {
            isRecordMode = !isRecordMode; // 모드 토글
            updateSectionVisibility(); // 가시성 업데이트
            
            // 코멘트 모드로 전환 시, AI 코멘트 내용 다시 계산
            if (!isRecordMode) {
                const allRecords = Array.from(recordsListScrollable.children).filter(el => el.classList.contains('record-item') && el.id !== 'no-records-placeholder');
                updateAIComment(allRecords);
            }
        });

        // "AI와 채팅하기" 버튼 클릭 이벤트
        aiChatButton.addEventListener('click', function() {
            alert('AI 채팅 페이지로 이동합니다!');
            // 실제 구현 시 window.location.href = '/chat'; 등으로 페이지 이동
        });


        // 초기 로드 시 설정
        document.addEventListener('DOMContentLoaded', function() {
            // 초기 상태는 기록 모드로 시작하며, 코멘트 블록은 숨겨집니다.
            isRecordMode = true; 
            updateSectionVisibility();
            updateDailyQuote(); // 초기 명언 설정
            setInterval(updateDailyQuote, 10000); // 10초마다 명언 변경 (선택 사항)

            // 초기 기록이 없는 경우 placeholder 표시
            const initialRecords = Array.from(recordsListScrollable.children).filter(el => el.classList.contains('record-item') && el.id !== 'no-records-placeholder');
            if (initialRecords.length === 0) {
                noRecordsPlaceholder.classList.remove('hidden');
            } else {
                noRecordsPlaceholder.classList.add('hidden');
            }
            updateAIComment(initialRecords); // 초기 AI 코멘트 내용 설정 (숨겨져 있어도 내용 미리 준비)
        });

        // --- 동적 달력/일기/모달 스크립트 ---
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        const userId = /*[[${user != null}]]*/ false ? '[[${user.userId}]]' : 1; // Thymeleaf에서 유저ID 주입, 없으면 1
        let currentDiaries = [];
        let selectedDate = null;

        function renderCalendar(year, month, diaryData) {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            const days = ['월','화','수','목','금','토','일'];
            days.forEach(d => {
                const div = document.createElement('div');
                div.className = 'text-center font-medium';
                div.textContent = d;
                calendarGrid.appendChild(div);
            });
            
            // 월요일이 0, 일요일이 6이 되도록 조정
            let firstDay = new Date(year, month-1, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1; // 일요일(0)을 6으로, 월요일(1)을 0으로 변환
            
            const lastDate = new Date(year, month, 0).getDate();
            const today = new Date();
            
            // 이전 달의 마지막 날짜들 계산
            const prevMonth = month === 1 ? 12 : month - 1;
            const prevYear = month === 1 ? year - 1 : year;
            const prevMonthLastDate = new Date(prevYear, prevMonth, 0).getDate();
            
            // 이전 달의 날짜들을 흐릿하게 표시
            for(let i=0; i<firstDay; i++) {
                const prevDate = prevMonthLastDate - firstDay + i + 1;
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                cell.style.opacity = '0.3';
                cell.style.background = '#f8f8f8';
                cell.style.cursor = 'default';
                cell.style.pointerEvents = 'none';
                
                const numSpan = document.createElement('span');
                numSpan.className = 'date-number';
                // 이전 달의 유효한 날짜 범위를 벗어나지 않도록 체크
                if (prevDate > 0 && prevDate <= prevMonthLastDate) {
                    numSpan.textContent = prevDate;
                } else {
                    numSpan.textContent = ''; // 빈 칸으로 표시
                }
                // 디버깅용 콘솔 로그 (나중에 제거)
                console.log(`prevDate: ${prevDate}, prevMonthLastDate: ${prevMonthLastDate}, firstDay: ${firstDay}, i: ${i}`);
                numSpan.style.color = '#999';
                cell.appendChild(numSpan);
                
                calendarGrid.appendChild(cell);
            }
            
            // 현재 달의 날짜들
            for(let d=1; d<=lastDate; d++) {
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                // 날짜 숫자 중앙 표시
                const numSpan = document.createElement('span');
                numSpan.className = 'date-number';
                numSpan.textContent = d;
                cell.appendChild(numSpan);
                // 일기 데이터가 있으면 표시
                const diary = diaryData.find(item => new Date(item.createdAt).getDate() === d);
                if (diary) {
                    cell.classList.add('has-diary');
                    // appliedStamp는 포인트 계산용이므로 이미지로 사용하지 않음, 참잘했어요 스탬프만 고정 표시
                    const img = document.createElement('img');
                    img.src = '/images/참잘했어요.png';
                    img.alt = '참잘했어요 스탬프';
                    img.className = 'stamp-image-calendar';
                    cell.appendChild(img);
                    if (diary.emotion) {
                        const span = document.createElement('span');
                        span.className = 'emotion-icon';
                        span.textContent = diary.emotion;
                        cell.appendChild(span);
                    }
                }
                if (year === today.getFullYear() && month === today.getMonth()+1 && d === today.getDate()) {
                    cell.classList.add('today');
                }
                const isFuture = (year > today.getFullYear()) ||
                    (year === today.getFullYear() && month > today.getMonth()+1) ||
                    (year === today.getFullYear() && month === today.getMonth()+1 && d > today.getDate());
                if (isFuture) {
                    cell.style.pointerEvents = 'none';
                    cell.style.opacity = '0.5';
                    cell.style.background = '#f3f3f3';
                } else {
                    cell.onclick = function() {
                        selectDiaryDate(year, month, d, diaryData);
                    };
                }
                calendarGrid.appendChild(cell);
            }
            
            // 다음 달의 날짜들을 흐릿하게 표시
            const totalCells = 35; // 5주 x 7일 = 35개 셀
            const filledCells = firstDay + lastDate;
            const remainingCells = totalCells - filledCells;
            
            for(let i=1; i<=remainingCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                cell.style.opacity = '0.3';
                cell.style.background = '#f8f8f8';
                cell.style.cursor = 'default';
                cell.style.pointerEvents = 'none';
                
                const numSpan = document.createElement('span');
                numSpan.className = 'date-number';
                numSpan.textContent = i;
                numSpan.style.color = '#999';
                cell.appendChild(numSpan);
                
                calendarGrid.appendChild(cell);
            }
        }
        function selectDiaryDate(year, month, day, diaryData) {
            selectedDate = new Date(year, month-1, day);
            // 해당 날짜의 모든 기록(시간별 등) 필터링
            const records = diaryData.filter(item => {
                const d = new Date(item.createdAt);
                return d.getFullYear() === year && d.getMonth()+1 === month && d.getDate() === day;
            });
            renderRecordsList(records, year, month, day);
        }
        function renderRecordsList(records, year, month, day) {
            const recordsList = document.getElementById('today-records-list-scrollable');
            recordsList.innerHTML = '';
            if (records.length === 0) {
                recordsList.innerHTML = `<p class='text-[#8F9562] text-center py-4'>이 날짜의 기록이 없습니다. 기록을 남겨보세요!</p>`;
            } else {
                records.slice().reverse().forEach(rec => {
                    const time = formatAMPM(new Date(rec.createdAt));
                    recordsList.innerHTML += `<div class='record-item'>
                        <span class='text-[#8F9562] text-sm mr-2'>[${time}]</span>
                        <span>${rec.content}</span>
                        <span class='ml-2'>${rec.emotion ? '감정: '+rec.emotion : ''}</span>
                        <!-- appliedStamp 이미지는 표시하지 않음 -->
                    </div>`;
                });
            }
            // 오른쪽 상단에 날짜 표시(선택적)
            const header = document.querySelector('.right-section-container h2');
            if (header) header.textContent = `${year}년 ${month}월 ${day}일 기록`;

            // 오늘 날짜면 스크롤을 맨 아래로 이동
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth()+1 && day === today.getDate()) {
                setTimeout(() => { recordsList.scrollTop = recordsList.scrollHeight; }, 0);
            }

            // 오늘 이전 날짜면 기록 입력창 숨기고 코멘트만 보이게, 일기 없는 날은 코멘트 숨김
            const isPast = (year < today.getFullYear()) ||
                (year === today.getFullYear() && month < today.getMonth()+1) ||
                (year === today.getFullYear() && month === today.getMonth()+1 && day < today.getDate());
            const newRecordSection = document.getElementById('new-record-section');
            const saveDiaryBtn = document.getElementById('save-diary-btn');
            const aiCommentSection = document.getElementById('ai-comment-section');
            if (isPast) {
                if (newRecordSection) newRecordSection.classList.add('hidden');
                if (saveDiaryBtn) saveDiaryBtn.classList.add('hidden');
                if (aiCommentSection) {
                    if (records.length > 0) aiCommentSection.classList.remove('hidden');
                    else aiCommentSection.classList.add('hidden');
                }
            } else {
                if (newRecordSection) newRecordSection.classList.remove('hidden');
                if (saveDiaryBtn) saveDiaryBtn.classList.remove('hidden');
                if (aiCommentSection) aiCommentSection.classList.add('hidden');
            }
        }
        document.getElementById('prev-month-btn').onclick = function() {
            if (--currentMonth < 1) { currentMonth = 12; currentYear--; }
            fetchAndRender();
        };
        document.getElementById('next-month-btn').onclick = function() {
            if (++currentMonth > 12) { currentMonth = 1; currentYear++; }
            fetchAndRender();
        };
        function fetchAndRender() {
            document.getElementById('calendar-title').textContent = `${currentYear}년 ${currentMonth}월`;
            fetch(`/api/diaries?userId=${userId}&year=${currentYear}&month=${currentMonth}`)
                .then(res => res.json())
                .then(data => {
                    currentDiaries = data.data || [];
                    renderCalendar(currentYear, currentMonth, currentDiaries);
                    updateCalendarSummary(currentDiaries, currentYear, currentMonth);
                    renderWeeklyReports(currentDiaries, currentYear, currentMonth);
                    // 기본: 오늘 날짜의 기록 표시
                    const today = new Date();
                    if (currentYear === today.getFullYear() && currentMonth === today.getMonth()+1) {
                        selectDiaryDate(currentYear, currentMonth, today.getDate(), currentDiaries);
                    } else {
                        renderRecordsList([], currentYear, currentMonth, 1);
                    }
                });
        }

        // 주차별 감정 리포트 동적 생성
        // 주차별 리포트 수정부분입니다! 수민님참고!
        function renderWeeklyReports(diaryData, year, month) {
            const reportsList = document.getElementById('weekly-reports-list');
            reportsList.innerHTML = '';
            
            // 1. 해당 월 1일이 속한 주의 월요일 찾기 (전월 포함)
            const firstDate = new Date(year, month-1, 1);
            let firstMonday = new Date(firstDate);
            let dayOfWeek = firstDate.getDay(); // 0:일, 1:월, ... 6:토
            
            // 1일이 월요일이 아니면, 그 주의 월요일을 전월로 이동해서 찾음
            if (dayOfWeek !== 1) {
                // 1일에서 dayOfWeek-1 만큼 빼면 그 주 월요일
                let diff = (dayOfWeek === 0) ? 6 : (dayOfWeek - 1);
                firstMonday.setDate(firstDate.getDate() - diff);
            }
            
            // 2. 각 주차별로 월~일 구간 계산 (전월 포함하여 전체 주차 표시)
            const lastDateNum = new Date(year, month, 0).getDate();
            let weekStart = new Date(firstMonday);
            let weekIdx = 1;
            
            while (true) {
                let weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                // 주차의 시작일과 종료일
                let startDay = weekStart.getDate();
                let endDay = weekEnd.getDate();
                let startMonth = weekStart.getMonth() + 1;
                let endMonth = weekEnd.getMonth() + 1;
                let startYear = weekStart.getFullYear();
                let endYear = weekEnd.getFullYear();
                
                // 주차가 해당 월에 속하는지 확인 (시작일이나 종료일 중 하나라도 해당 월에 속하면)
                if (startMonth === month || endMonth === month) {
                    // 주차의 시작일과 종료일
                    let startDay = weekStart.getDate();
                    let endDay = weekEnd.getDate();
                    let startMonth = weekStart.getMonth() + 1;
                    let endMonth = weekEnd.getMonth() + 1;
                    let startYear = weekStart.getFullYear();
                    let endYear = weekEnd.getFullYear();
                    
                    // 일요일이 포함된 월을 기준으로 리포트 월 결정
                    let reportMonth = endMonth; // 일요일이 있는 월
                    let reportYear = endYear;
                    
                    // 해당 월의 몇 번째 주차인지 계산
                    let reportWeekIdx = 1;
                    let tempWeekStart = new Date(reportYear, reportMonth-1, 1);
                    let tempDayOfWeek = tempWeekStart.getDay();
                    
                    // 해당 월 1일이 속한 주의 월요일 찾기
                    if (tempDayOfWeek !== 1) {
                        let diff = (tempDayOfWeek === 0) ? 6 : (tempDayOfWeek - 1);
                        tempWeekStart.setDate(tempWeekStart.getDate() - diff);
                    }
                    
                    // 현재 주차가 해당 월의 몇 번째 주차인지 계산
                    while (tempWeekStart.getTime() < weekEnd.getTime()) {
                        tempWeekStart.setDate(tempWeekStart.getDate() + 7);
                        if (tempWeekStart.getTime() <= weekEnd.getTime()) {
                            reportWeekIdx++;
                        }
                    }
                    
                    // 일요일이 포함된 월이 현재 보고 있는 월과 같은 경우에만 리포트 표시
                    if (reportMonth === month) {
                        // 텍스트 예: 7월 1주차 리포트 (6/30 ~ 7/6)
                        let weekLabel = `${reportMonth}월 ${reportWeekIdx}주차 리포트 (${startMonth}/${startDay} ~ ${endMonth}/${endDay})`;
                        
                        // 리포트 블록 생성
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between bg-white p-4 rounded-lg border border-[#B87B5C]';
                        const span = document.createElement('span');
                        span.className = 'text-[#495235] font-medium';
                        span.textContent = weekLabel;
                        div.appendChild(span);
                        const btn = document.createElement('button');
                        btn.className = 'btn-nav bg-[#8F9562] hover:bg-[#495235] text-sm';
                        btn.textContent = '리포트 보기';
                        btn.onclick = () => alert(`${weekLabel} 페이지로 이동합니다!`);
                        div.appendChild(btn);
                        reportsList.appendChild(div);
                    }
                }
                
                // 다음 주로 이동
                weekStart.setDate(weekStart.getDate() + 7);
                weekIdx++;
                
                // 주차 시작일이 해당 월을 완전히 벗어나면 종료
                if (weekStart.getMonth() > month-1) break;
            }
        }
        // 달력 요약(이번 달 일기, 연속 기록) 갱신 함수
        function updateCalendarSummary(diaryData, year, month) {
            // 1. 날짜별로 일기 작성 여부 집계
            const daysWithDiary = new Set();
            diaryData.forEach(item => {
                const d = new Date(item.createdAt);
                if (d.getFullYear() === year && d.getMonth()+1 === month) {
                    daysWithDiary.add(d.getDate());
                }
            });
            const diaryCount = daysWithDiary.size;

            // 2. 연속 기록 계산
            // 날짜 배열로 변환 후 정렬
            const sortedDays = Array.from(daysWithDiary).sort((a, b) => a - b);
            let maxStreak = 0, curStreak = 0, prevDay = null;
            sortedDays.forEach(day => {
                if (prevDay !== null && day === prevDay + 1) {
                    curStreak++;
                } else {
                    curStreak = 1;
                }
                if (curStreak > maxStreak) maxStreak = curStreak;
                prevDay = day;
            });

            // 3. DOM에 반영
            const summary = document.getElementById('calendar-summary');
            if (summary) {
                summary.textContent = `이번 달 일기: ${diaryCount}일 작성 | 연속 기록: ${maxStreak}일`;
            }
        }
        // 최초 렌더링
        fetchAndRender();
    </script>
</body>
</html>